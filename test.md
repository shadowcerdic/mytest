
<div dir="rtl">

# تحلیل جامع فرآیندهای System و Memory Compression در ویندوز

## مقدمه

در معماری سیستم‌عامل ویندوز، فرآیندهای خاصی وجود دارند که درک آن‌ها برای مدیریت، بهینه‌سازی و امنیت سیستم حیاتی است. دو مورد از مهم‌ترین و در عین حال گاهی مبهم‌ترینِ این فرآیندها، «System» و «Memory Compression» هستند. این راهنما به تحلیل عمیق این دو فرآیند، رفتارهای عادی و مشکوک آن‌ها و روش‌های عملی برای بررسی آن‌ها می‌پردازد.

---

## ۱. فرآیند System (PID 4): قلب تپنده کرنل

فرآیند **System** با شناسه فرآیند (PID) ثابت **4**، یکی از اصلی‌ترین و بنیادی‌ترین موجودیت‌ها در هسته (Kernel) ویندوز است. این فرآیند، یک فرآیند واقعی در فضای کاربر (User Space) مانند سایر برنامه‌ها نیست؛ بلکه در ابزارهایی مانند Task Manager، بازتابی از تمام فعالیت‌ها و تِرِدهای در حال اجرا در حالت هسته (Kernel Mode Threads) است.

این فرآیند در واقع نمایانگر عملکرد خودِ هسته ویندوز (فایل `ntoskrnl.exe`) بوده و مسئولیت اجرای روتین‌های وقفه (Interrupt Routines) و روندهای زمان‌بندی (Scheduling) را بر عهده دارد.

<h3 dir="rtl">ویژگی‌های کلیدی</h3>

<ul dir="rtl">
  <li><b>PID:</b> همیشه و به صورت ثابت <code>4</code> است.</li>
  <li><b>مالک (Owner):</b> تحت حساب کاربری <code>NT AUTHORITY\SYSTEM</code> اجرا می‌شود.</li>
  <li><b>والد (Parent):</b> هیچ (این فرآیند ریشه است و توسط هسته در زمان بوت ایجاد می‌شود).</li>
  <li><b>فرزند (Child):</b> در یک سیستم سالم، فرآیند System تنها و فقط یک فرآیند فرزند به نام <code>smss.exe</code> (Session Manager Subsystem) دارد.</li>
  <li><b>مسیر اجرایی:</b> فاقد مسیر اجرایی در فضای کاربر است. در Process Explorer به عنوان "None" نمایش داده می‌شود.</li>
</ul>

### وظایف اصلی

فرآیند System میزبان تمامی تردهای کرنلی است که وظایف حیاتی سیستم را مدیریت می‌کنند، از جمله:

- **مدیریت حافظه (Memory Manager Threads):** برای تخصیص حافظه در Kernel Pool.
- **عملیات ورودی/خروجی (I/O Workers):** برای کنترل دیسک و شبکه.
- **توزیع بار پردازشی (Balancer Threads):** برای متعادل‌سازی بار کاری بین هسته‌های CPU.
- **ارتباطات بین پردازشی (IPC):** مدیریت System Calls، DPCs و Interrupts.

---

## ۲. فرآیند Memory Compression: بهینه‌ساز حافظه مدرن

فرآیند **Memory Compression** یکی از قابلیت‌های نسبتاً جدید است که از ویندوز ۱۰ (Build 10586) به بعد معرفی شد. این فرآیند یک موجودیت سیستمی است که با هدف بهبود عملکرد و زمان پاسخ‌دهی سیستم، به‌خصوص در زمان کمبود حافظه فیزیکی (RAM)، طراحی شده است.

### عملکرد و هدف

در گذشته، زمانی که RAM سیستم پر می‌شد، ویندوز داده‌های غیرفعال را به فایل صفحه‌بندی (`Pagefile.sys`) روی دیسک سخت منتقل می‌کرد. این فرآیند (Paging) به دلیل کُند بودن دیسک نسبت به حافظه، باعث افت شدید عملکرد می‌شد.

فرآیند Memory Compression این چرخه را بهینه‌سازی می‌کند. به جای انتقال مستقیم داده‌ها به دیسک، ابتدا سعی می‌کند بخش‌هایی از حافظه فرآیندهای غیرفعال را درون خودِ RAM فشرده‌سازی کند. این کار فضای خالی در RAM ایجاد می‌کند و نیاز به مراجعه به دیسک را به شدت کاهش می‌دهد.

<p align="center">
  <img src="https://i.imgur.com/vHq4R7F.png" alt="Memory Compression Flow Diagram" width="600"/>
</p>

### ویژگی‌های کلیدی

- **والد (Parent):** این فرآیند فرزند فرآیند `System` (PID 4) محسوب می‌شود.
- **فرزند (Child):** هیچ فرآیند فرزندی ندارد.
- **مالک (Owner):** تحت حساب کاربری `NT AUTHORITY\SYSTEM` اجرا می‌شود.
- **تعداد:** همیشه تنها یک نمونه از آن در سیستم فعال است.
- **عملکرد داخلی:** این فرآیند بخشی از مدیریت حافظه (Memory Manager) در کرنل است و از ساختاری به نام **Store Manager** برای نگهداری صفحات فشرده (`SMKM_STORE`) استفاده می‌کند.

---

<h2 dir="rtl">۳. بخش‌های کاربردی و عملیاتی</h2>

<h3 dir="rtl">راهنمای عملی تحلیل</h3>

<p dir="rtl">در این بخش، دستورات و ابزارهای کلیدی برای تحلیل این دو فرآیند معرفی می‌شوند.</p>

<h4 dir="rtl">ابزارهای مجموعه Sysinternals Suite</h4>

<p dir="rtl">مجموعه ابزار Sysinternals که توسط مایکروسافت پشتیبانی می‌شود، برای عیب‌یابی و مدیریت پیشرفته ویندوز ضروری است.</p>

<ul dir="rtl">
  <li><b>Process Explorer:</b> جایگزینی قدرتمند برای Task Manager است. با استفاده از این ابزار می‌توان به راحتی ساختار سلسله‌مراتبی فرآیند System و فرزندان آن را مشاهده کرد.</li>
  <li><b>Process Monitor:</b> این ابزار فعالیت‌های فایل سیستم، رجیستری و شبکه را به صورت زنده نمایش می‌دهد و برای شناسایی دسترسی‌های غیرمجاز توسط این فرآیندها بسیار کارآمد است.</li>
  <li><b>Sysmon:</b> ابزاری پیشرفته برای نظارت و ثبت رویدادهای سیستمی در Event Log است. با پیکربندی صحیح، Sysmon می‌تواند فعالیت‌های مشکوک مانند ایجاد فرآیندهای غیرعادی توسط System را ثبت کند.</li>
</ul>

#### دستورات PowerShell :PowerShell یک ابزار خط فرمان و زبان اسکریپت‌نویسی قدرتمند برای مدیریت و خودکارسازی وظایف در ویندوز است. در زمینه تحلیل فرآیندهای سیستمی، می‌توان از دستورات زیر استفاده کرد:- **نمایش اطلاعات فرآیند:**

<div dir="ltr">

```powershell
# Get information about the System process
Get-Process -Id 4 | Format-List *

# Get information about the Memory Compression process
Get-Process -Name "Memory Compression"
```

</div>

- **بررسی و مدیریت وضعیت Memory Compression:**

<div dir="ltr">

```powershell
# Check if Memory Compression is enabled
Get-MMAgent

# Disable Memory Compression (requires Admin rights)
Disable-MMAgent -mc

# Enable Memory Compression (requires Admin rights)
Enable-MMAgent -mc
```

</div>

#### ابزار Volatility برای تحلیل حافظه (Memory Forensics)

Volatility یک فریم‌ورک متن‌باز برای تحلیل حافظه dump است و می‌تواند شواهد فعالیت‌های مخرب را از حافظه استخراج کند.

1.  **تهیه Dump حافظه:** از یک سیستم مشکوک، یک Image کامل از حافظه RAM تهیه کنید.
2.  **لیست فرآیندها:** با پلاگین `windows.pslist.PsList` لیست فرآیندها را بررسی کنید و به دنبال ناهنجاری در فرآیند System باشید.
3.  **کدهای تزریق‌شده:** از پلاگین `windows.malfind.Malfind` برای یافتن کدهای تزریق‌شده به فرآیندهای سیستمی استفاده کنید.
4.  **بررسی ماژول‌های کرنل:** با پلاگین `windows.modules.Modules` لیست درایورهای بارگذاری‌شده را تحلیل کرده و به دنبال موارد مخفی یا مشکوک بگردید.

<h3 dir="rtl">جدول مقایسه‌ای: رفتار عادی در مقابل مشکوک</h3>

<table dir="rtl">
  <tr>
    <th>ویژگی</th>
    <th>رفتار عادی (Normal)</th>
    <th>رفتار مشکوک (Suspicious / IoC)</th>
  </tr>
  <tr>
    <td><b>فرآیند System (PID 4)</b></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>تعداد نمونه‌ها</td>
    <td>دقیقاً یک نمونه با PID <code>4</code>.</td>
    <td>بیش از یک نمونه.</td>
  </tr>
  <tr>
    <td>فرآیند والد</td>
    <td>ندارد (ریشه است).</td>
    <td>داشتن یک فرآیند والد دیگر.</td>
  </tr>
  <tr>
    <td>فرآیند فرزند</td>
    <td>فقط <code>smss.exe</code>.</td>
    <td>هر فرزندی غیر از <code>smss.exe</code> یا داشتن چندین فرزند.</td>
  </tr>
  <tr>
    <td>فعالیت شبکه</td>
    <td>محدود به درایورهای کرنل (مثل <code>HTTP.sys</code>). معمولاً پورت باز ندارد.</td>
    <td>شنود روی پورت‌های شناخته‌شده (80, 443, 445) یا ایجاد اتصالات خروجی.</td>
  </tr>
  <tr>
    <td>مصرف CPU</td>
    <td>در حالت بیکار نزدیک به صفر.</td>
    <td>مصرف پایدار و بالای CPU حتی در زمان بیکاری سیستم.</td>
  </tr>
  <tr>
    <td><b>فرآیند Memory Compression</b></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>تعداد نمونه‌ها</td>
    <td>دقیقاً یک نمونه.</td>
    <td>بیش از یک نمونه.</td>
  </tr>
  <tr>
    <td>فرآیند والد</td>
    <td>فرآیند <code>System</code> (PID 4).</td>
    <td>هر والدی غیر از فرآیند System.</td>
  </tr>
  <tr>
    <td>فرآیند فرزند</td>
    <td>ندارد.</td>
    <td>داشتن هرگونه فرآیند فرزند.</td>
  </tr>
  <tr>
    <td>فعالیت شبکه/دیسک</td>
    <td>نباید هیچ فعالیت مستقیم شبکه‌ای یا I/O دیسک داشته باشد.</td>
    <td>مشاهده اتصالات شبکه، خواندن/نوشتن فایل روی دیسک.</td>
  </tr>
  <tr>
    <td>حجم حافظه</td>
    <td>متناسب با فشار روی RAM افزایش می‌یابد.</td>
    <td>افزایش شدید و ناگهانی حجم حافظه فشرده بدون دلیل مشخص.</td>
  </tr>
</table>

### چک‌لیست امنیتی برای تحلیلگران

1.  [ ] **بررسی تعداد و PID:** آیا فقط یک فرآیند `System` با `PID 4` وجود دارد؟
2.  [ ] **بررسی ساختار والد-فرزند:** آیا والد فرآیند `System` خالی است و تنها فرزند آن `smss.exe` است؟
3.  [ ] **بررسی والد Memory Compression:** آیا والد فرآیند `Memory Compression`، فرآیند `System` است؟
4.  [ ] **نظارت بر اتصالات شبکه:** با استفاده از `netstat -ano` یا TCPView، بررسی کنید که آیا `PID 4` یا `Memory Compression` فعالیت شبکه‌ای غیرمنتظره‌ای دارند.
5.  [ ] **تحلیل مصرف منابع:** آیا مصرف CPU یا حافظه این فرآیندها بدون دلیل مشخص بالاست؟
6.  [ ] **بررسی ماژول‌های کرنل:** با Process Explorer، درایورهای بارگذاری‌شده را بررسی کرده و به دنبال موارد ناشناس یا بدون امضای دیجیتال معتبر بگردید.
7.  [ ] **بررسی لاگ‌های Sysmon:** رخدادهای ایجاد فرآیند (Event ID 1) و دسترسی به فرآیند (Event ID 10) را برای شناسایی فعالیت‌های مشکوک تحلیل کنید.

---

<h2 dir="rtl">۴. عمق فنی بیشتر و روش‌های شناسایی Rootkit</h2>

<h3 dir="rtl">معماری داخلی کرنل</h3>

<ul dir="rtl">
  <li><b>EPROCESS:</b> ساختاری در کرنل که تمام اطلاعات یک فرآیند (PID، والد، توکن دسترسی و...) را نگهداری می‌کند. کرنل لیست دوطرفه‌ای (Doubly-Linked List) از تمام ساختارهای <code>EPROCESS</code> را در متغیر <code>PsActiveProcessHead</code> ذخیره می‌کند.</li>
  <li><b>PsLoadedModuleList:</b> لیستی در کرنل که اطلاعات تمام درایورها و ماژول‌های بارگذاری‌شده در فضای هسته را شامل می‌شود.</li>
</ul>

<h3 dir="rtl">تکنیک‌های شناسایی Rootkit</h3>

<p dir="rtl">Rootkitها بدافزارهایی هستند که در سطح کرنل عمل کرده و با دستکاری ساختارهای داخلی سیستم‌عامل، خود را پنهان می‌کنند.</p>

<ul dir="rtl">
  <li><b>DKOM (Direct Kernel Object Manipulation):</b> بدافزار مستقیماً ساختار <code>EPROCESS</code> را دستکاری می‌کند و با حذف گره مربوط به فرآیند خود از لیست <code>PsActiveProcessHead</code>، آن را از دید ابزارهای مانیتورینگ پنهان می‌کند.</li>
  <li><b>SSDT Hooking (System Service Descriptor Table):</b> بدافزار جدول فراخوانی‌های سیستمی (SSDT) را دستکاری کرده و آدرس توابع سیستمی را با آدرس کد مخرب خود جایگزین می‌کند.</li>
  <li><b>IRP Hooking (I/O Request Packet):</b> بدافزار توابع مدیریت درخواست‌های ورودی/خروجی (IRP) در درایورها را Hook می‌کند تا بتواند داده‌های مربوط به شبکه یا فایل سیستم را شنود یا دستکاری کند.</li>
</ul>
---

## ۵. بخش‌های تکمیلی و منابع

### نگاشت به چارچوب MITRE ATT&CK®

| شناسه | عنوان | توضیح فارسی |
| :---: | :--- | :--- |
| **T1068** | Exploitation for Privilege Escalation | بهره‌برداری از آسیب‌پذیری درایورها برای اجرای کد در سطح کرنل. |
| **T1547.006** | Boot or Logon Autostart Execution: Kernel Modules and Drivers | بارگذاری یک درایور مخرب (Rootkit) برای تضمین پایداری. |
| **T1055** | Process Injection | تزریق کد به فرآیندهای سیستمی در سطح کرنل. |
| **T1014** | Rootkit | پنهان‌سازی فعالیت‌ها با دستکاری مستقیم ساختارهای کرنل. |

### سناریوها و مطالعات موردی

- **نفوذ از طریق درایور HTTP.sys:** مهاجمان با بهره‌برداری از آسیب‌پذیری در درایور `HTTP.sys` (که در بستر فرآیند System اجرا می‌شود)، یک وب‌شل (Web Shell) در سطح کرنل پیاده‌سازی کرده و به شنود ترافیک می‌پردازند.
- **پنهان‌سازی Payload در Memory Compression:** تحلیل‌های امنیتی (مانند گزارش‌های Google TAG) نشان داده‌اند که بدافزارهای پیشرفته، Payload خود را به حافظه فشرده‌شده منتقل می‌کنند تا از اسکن ابزارهای تحلیل حافظه در امان بمانند.

### کوئری‌های Sysmon نمونه

برای شناسایی فعالیت‌های مشکوک، می‌توانید از کوئری‌های زیر در سیستم SIEM خود استفاده کنید.

- **شناسایی فرزندی غیر از smss.exe برای System:**

<div dir="ltr">

```xml
<Sysmon schemaversion="4.30">
  <EventFiltering>
    <RuleGroup name="" groupRelation="or">
      <ProcessCreate onmatch="include">
        <Rule groupRelation="and">
          <ParentImage condition="is">System</ParentImage>
          <Image condition="not contains">smss.exe</Image>
        </Rule>
      </ProcessCreate>
    </RuleGroup>
  </EventFiltering>
</Sysmon>
```

</div>

### منابع بیشتر برای مطالعه

- **Microsoft Docs:** [مستندات رسمی Sysinternals Suite](https://docs.microsoft.com/en-us/sysinternals/)
- **کتاب:** *Windows Internals, Part 1 & 2*
- **وب‌سایت:** [The Volatility Foundation](https://www.volatilityfoundation.org/)

</div>
